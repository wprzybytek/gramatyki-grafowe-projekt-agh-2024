import networkx as nx

from productions.p03.utils import prepare_valid_test_graph_p3
from productions.p04.production4 import ProductionP4
from productions.p04.utils import prepare_valid_test_graph_p4, prepare_valid_big_test_graph_p4


def test_basic_graph():
    """ Verifies if structure is valid after applying production 4 to a basic graph"""
    G = prepare_valid_test_graph_p4()

    prod4 = ProductionP4(G)
    prod4.apply()

    expected_graph = {
        'Q:0.25:0.25': {
            'v:0.0:0.0': {},
            'v:0.0:0.5': {},
            'v:0.5:0.0': {},
            'v:0.5:0.5': {}
        },
        'Q:0.25:0.75': {
            'v:0.0:0.5': {},
            'v:0.0:1.0': {},
            'v:0.5:0.5': {},
            'v:0.5:1.0': {}
        },
        'Q:0.75:0.25': {
            'v:0.5:0.0': {},
            'v:0.5:0.5': {},
            'v:1.0:0.0': {},
            'v:1.0:0.5': {}
        },
        'Q:0.75:0.75': {
            'v:0.5:0.5': {},
            'v:0.5:1.0': {},
            'v:1.0:0.5': {},
            'v:1.0:1.0': {}
        },
        'v:0.0:0.0': {
            'Q:0.25:0.25': {},
            'v:0.0:0.5': {'B': 1, 'label': 'E'},
            'v:0.5:0.0': {'B': 1, 'label': 'E'}
        },
        'v:0.0:0.5': {
            'Q:0.25:0.25': {},
            'Q:0.25:0.75': {},
            'v:0.0:0.0': {'B': 1, 'label': 'E'},
            'v:0.0:1.0': {'B': 1, 'label': 'E'},
            'v:0.5:0.5': {'B': 0, 'label': 'E'}
        },
        'v:0.0:1.0': {
            'Q:0.25:0.75': {},
            'v:0.0:0.5': {'B': 1, 'label': 'E'},
            'v:0.5:1.0': {'B': 1, 'label': 'E'}
        },
        'v:0.5:0.0': {
            'Q:0.25:0.25': {},
            'Q:0.75:0.25': {},
            'v:0.0:0.0': {'B': 1, 'label': 'E'},
            'v:0.5:0.5': {'B': 0, 'label': 'E'},
            'v:1.0:0.0': {'B': 1, 'label': 'E'}
        },
        'v:0.5:0.5': {
            'Q:0.25:0.25': {},
            'Q:0.25:0.75': {},
            'Q:0.75:0.25': {},
            'Q:0.75:0.75': {},
            'v:0.0:0.5': {'B': 0, 'label': 'E'},
            'v:0.5:0.0': {'B': 0, 'label': 'E'},
            'v:0.5:1.0': {'B': 0, 'label': 'E'},
            'v:1.0:0.5': {'B': 0, 'label': 'E'}
        },
        'v:0.5:1.0': {
            'Q:0.25:0.75': {},
            'Q:0.75:0.75': {},
            'v:0.0:1.0': {'B': 1, 'label': 'E'},
            'v:0.5:0.5': {'B': 0, 'label': 'E'},
            'v:1.0:1.0': {'B': 1, 'label': 'E'}
        },
        'v:1.0:0.0': {
            'Q:0.75:0.25': {},
            'v:0.5:0.0': {'B': 1, 'label': 'E'},
            'v:1.0:0.5': {'B': 1, 'label': 'E'}
        },
        'v:1.0:0.5': {
            'Q:0.75:0.25': {},
            'Q:0.75:0.75': {},
            'v:0.5:0.5': {'B': 0, 'label': 'E'},
            'v:1.0:0.0': {'B': 1, 'label': 'E'},
            'v:1.0:1.0': {'B': 1, 'label': 'E'}
        },
        'v:1.0:1.0': {
            'Q:0.75:0.75': {},
            'v:0.5:1.0': {'B': 1, 'label': 'E'},
            'v:1.0:0.5': {'B': 1, 'label': 'E'}
        },
    }
    assert expected_graph == nx.to_dict_of_dicts(G)


def test_basic_graph_with_missing_hanging_node():
    """ Verifies if production 4 was not applied to a basic graph with missing hanging node"""
    G = prepare_valid_test_graph_p4()
    G.remove_node('v:0.5:1.0')
    G.add_edges_from([
        ('v:0.0:1.0', 'v:1.0:1.0', {'label': 'E', 'B': 1}),
    ])

    prod4 = ProductionP4(G)
    prod4.apply()

    expected_graph = {
        'Q': {
            'v:0.0:0.0': {},
            'v:1.0:0.0': {},
            'v:1.0:1.0': {},
            'v:0.0:1.0': {}
        },
        'v:0.0:0.0': {
            'v:0.5:0.0': {'label': 'E', 'B': 1},
            'v:0.0:1.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:1.0:0.0': {
            'v:0.5:0.0': {'label': 'E', 'B': 1},
            'v:1.0:1.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:1.0:1.0': {
            'v:1.0:0.0': {'label': 'E', 'B': 1},
            'Q': {},
            'v:0.0:1.0': {'label': 'E', 'B': 1},
        },
        'v:0.0:1.0': {
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'Q': {},
            'v:1.0:1.0': {'label': 'E', 'B': 1},
        },
        'v:0.5:0.0': {
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:1.0:0.0': {'label': 'E', 'B': 1},
        },
    }
    assert expected_graph == nx.to_dict_of_dicts(G)


def test_basic_graph_with_missing_edge():
    """ Verifies if production 4 was not applied to a basic graph with missing edge"""
    G = prepare_valid_test_graph_p4()
    G.remove_edge('v:1.0:1.0', 'v:0.5:1.0')

    prod4 = ProductionP4(G)
    prod4.apply()

    expected_graph = {
        'v:0.0:0.0': {
            'v:0.5:0.0': {'label': 'E', 'B': 1},
            'v:0.0:1.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:1.0:0.0': {
            'v:0.5:0.0': {'label': 'E', 'B': 1},
            'v:1.0:1.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:1.0:1.0': {'v:1.0:0.0': {'label': 'E', 'B': 1}, 'Q': {}},
        'v:0.0:1.0': {
            'v:0.5:1.0': {'label': 'E', 'B': 1},
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:0.5:1.0': {'v:0.0:1.0': {'label': 'E', 'B': 1}},
        'v:0.5:0.0': {
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:1.0:0.0': {'label': 'E', 'B': 1},
        },
        'Q': {'v:0.0:0.0': {}, 'v:1.0:0.0': {}, 'v:1.0:1.0': {}, 'v:0.0:1.0': {}},
    }
    assert expected_graph == nx.to_dict_of_dicts(G)


def test_basic_graph_with_missing_label():
    """ Verifies if production 4 was not applied to a basic graph with missing label"""
    G = prepare_valid_test_graph_p4()
    G.nodes['Q']['label'] = 'P'
    expected_graph = nx.to_dict_of_dicts(G)

    prod3 = ProductionP4(G)
    prod3.apply()

    assert expected_graph == nx.to_dict_of_dicts(G)


def test_basic_graph_with_neighboring_hanging_nodes():
    """ Verifies if structure is valid after applying production 3 to a graph with neighboring hanging nodes"""
    G = prepare_valid_test_graph_p3()
    expected_graph = nx.to_dict_of_dicts(G)

    prod3 = ProductionP4(G)
    prod3.apply()

    assert expected_graph == nx.to_dict_of_dicts(G)


def test_big_graph():
    """ Verifies if structure is valid after applying production 4 to a big graph"""
    G = prepare_valid_big_test_graph_p4()

    prod4 = ProductionP4(G)
    prod4.apply()

    expected_graph = {
        'v:0.0:0.0': {
            'v:2.5:0.0': {'label': 'E', 'B': 1},
            'v:0.0:2.5': {'label': 'E', 'B': 1},
            'Q:1.25:1.25': {},
        },
        'v:5.0:0.0': {
            'v:2.5:0.0': {'label': 'E', 'B': 1},
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'v:5.0:-5.0': {'label': 'E', 'B': 1},
            'Q:7.5:-2.5': {},
            'Q:3.75:1.25': {},
            'v:7.5:0.0': {'label': 'E', 'B': 0},
            'Q:6.25:1.25': {},
        },
        'v:10.0:0.0': {
            'v:12.5:0.0': {'label': 'E', 'B': 0},
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:10.0:-5.0': {'label': 'E', 'B': 0},
            'Q:12.5:-2.5': {},
            'Q:7.5:-2.5': {},
            'Q:11.25:1.25': {},
            'v:7.5:0.0': {'label': 'E', 'B': 0},
            'Q:8.75:1.25': {},
        },
        'v:10.0:5.0': {
            'v:12.5:5.0': {'label': 'E', 'B': 1},
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:10.0:10.0': {'label': 'E', 'B': 1},
            'Q:7.5:7.5': {},
            'Q:11.25:3.75': {},
            'v:7.5:5.0': {'label': 'E', 'B': 0},
            'Q:8.75:3.75': {},
        },
        'v:10.0:10.0': {
            'v:5.0:10.0': {'label': 'E', 'B': 1},
            'v:10.0:5.0': {'label': 'E', 'B': 1},
            'Q:7.5:7.5': {},
        },
        'v:5.0:10.0': {
            'v:2.5:10.0': {'label': 'E', 'B': 1},
            'v:5.0:7.5': {'label': 'E', 'B': 0},
            'v:10.0:10.0': {'label': 'E', 'B': 1},
            'Q:7.5:7.5': {},
            'Q:3.75:8.75': {},
        },
        'v:0.0:10.0': {
            'v:2.5:10.0': {'label': 'E', 'B': 1},
            'v:0.0:7.5': {'label': 'E', 'B': 1},
            'Q:1.25:8.75': {},
        },
        'v:0.0:5.0': {
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'v:0.0:2.5': {'label': 'E', 'B': 1},
            'v:0.0:7.5': {'label': 'E', 'B': 1},
            'Q:1.25:3.75': {},
            'Q:1.25:6.25': {},
        },
        'v:5.0:5.0': {
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'v:5.0:7.5': {'label': 'E', 'B': 0},
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'Q:7.5:7.5': {},
            'Q:3.75:3.75': {},
            'Q:3.75:6.25': {},
            'v:7.5:5.0': {'label': 'E', 'B': 0},
            'Q:6.25:3.75': {},
        },
        'v:5.0:-5.0': {
            'v:5.0:0.0': {'label': 'E', 'B': 1},
            'v:10.0:-5.0': {'label': 'E', 'B': 1},
            'Q:7.5:-2.5': {},
        },
        'v:10.0:-5.0': {
            'v:5.0:-5.0': {'label': 'E', 'B': 1},
            'v:15.0:-5.0': {'label': 'E', 'B': 1},
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'Q:12.5:-2.5': {},
            'Q:7.5:-2.5': {},
        },
        'v:15.0:-5.0': {
            'v:10.0:-5.0': {'label': 'E', 'B': 1},
            'v:15.0:0.0': {'label': 'E', 'B': 1},
            'Q:12.5:-2.5': {},
        },
        'v:15.0:0.0': {
            'v:12.5:0.0': {'label': 'E', 'B': 0},
            'v:15.0:2.5': {'label': 'E', 'B': 1},
            'v:15.0:-5.0': {'label': 'E', 'B': 1},
            'Q:12.5:-2.5': {},
            'Q:13.75:1.25': {},
        },
        'v:15.0:5.0': {
            'v:12.5:5.0': {'label': 'E', 'B': 1},
            'v:15.0:2.5': {'label': 'E', 'B': 1},
            'Q:13.75:3.75': {},
        },
        'v:2.5:10.0': {
            'v:0.0:10.0': {'label': 'E', 'B': 1},
            'v:5.0:10.0': {'label': 'E', 'B': 1},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:1.25:8.75': {},
            'Q:3.75:8.75': {},
        },
        'v:2.5:5.0': {
            'v:0.0:5.0': {'label': 'E', 'B': 0},
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:1.25:3.75': {},
            'Q:3.75:3.75': {},
            'Q:1.25:6.25': {},
            'Q:3.75:6.25': {},
        },
        'v:2.5:0.0': {
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:5.0:0.0': {'label': 'E', 'B': 1},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'Q:1.25:1.25': {},
            'Q:3.75:1.25': {},
        },
        'v:12.5:5.0': {
            'v:10.0:5.0': {'label': 'E', 'B': 1},
            'v:15.0:5.0': {'label': 'E', 'B': 1},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:11.25:3.75': {},
            'Q:13.75:3.75': {},
        },
        'v:12.5:0.0': {
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'v:15.0:0.0': {'label': 'E', 'B': 0},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:11.25:1.25': {},
            'Q:13.75:1.25': {},
        },
        'v:0.0:2.5': {
            'v:0.0:5.0': {'label': 'E', 'B': 1},
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'Q:1.25:1.25': {},
            'Q:1.25:3.75': {},
        },
        'v:0.0:7.5': {
            'v:0.0:10.0': {'label': 'E', 'B': 1},
            'v:0.0:5.0': {'label': 'E', 'B': 1},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:1.25:6.25': {},
            'Q:1.25:8.75': {},
        },
        'v:5.0:2.5': {
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:5.0:0.0': {'label': 'E', 'B': 0},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'Q:3.75:1.25': {},
            'Q:3.75:3.75': {},
            'v:7.5:2.5': {'label': 'E', 'B': 0},
            'Q:6.25:3.75': {},
            'Q:6.25:1.25': {},
        },
        'v:5.0:7.5': {
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:5.0:10.0': {'label': 'E', 'B': 0},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:3.75:6.25': {},
            'Q:3.75:8.75': {},
        },
        'v:10.0:2.5': {
            'v:10.0:5.0': {'label': 'E', 'B': 0},
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:11.25:1.25': {},
            'Q:11.25:3.75': {},
            'v:7.5:2.5': {'label': 'E', 'B': 0},
            'Q:8.75:1.25': {},
            'Q:8.75:3.75': {},
        },
        'v:15.0:2.5': {
            'v:15.0:5.0': {'label': 'E', 'B': 1},
            'v:15.0:0.0': {'label': 'E', 'B': 1},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:13.75:1.25': {},
            'Q:13.75:3.75': {},
        },
        'v:2.5:2.5': {
            'v:0.0:2.5': {'label': 'E', 'B': 0},
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'v:2.5:0.0': {'label': 'E', 'B': 0},
            'Q:1.25:1.25': {},
            'Q:1.25:3.75': {},
            'Q:3.75:1.25': {},
            'Q:3.75:3.75': {},
        },
        'v:2.5:7.5': {
            'v:0.0:7.5': {'label': 'E', 'B': 0},
            'v:2.5:10.0': {'label': 'E', 'B': 0},
            'v:5.0:7.5': {'label': 'E', 'B': 0},
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'Q:1.25:6.25': {},
            'Q:1.25:8.75': {},
            'Q:3.75:6.25': {},
            'Q:3.75:8.75': {},
        },
        'v:12.5:2.5': {
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:12.5:5.0': {'label': 'E', 'B': 0},
            'v:15.0:2.5': {'label': 'E', 'B': 0},
            'v:12.5:0.0': {'label': 'E', 'B': 0},
            'Q:11.25:1.25': {},
            'Q:11.25:3.75': {},
            'Q:13.75:1.25': {},
            'Q:13.75:3.75': {},
        },
        'Q:1.25:1.25': {'v:2.5:2.5': {}, 'v:0.0:0.0': {}, 'v:0.0:2.5': {}, 'v:2.5:0.0': {}},
        'Q:1.25:3.75': {'v:0.0:5.0': {}, 'v:2.5:5.0': {}, 'v:2.5:2.5': {}, 'v:0.0:2.5': {}},
        'Q:3.75:1.25': {'v:2.5:2.5': {}, 'v:2.5:0.0': {}, 'v:5.0:0.0': {}, 'v:5.0:2.5': {}},
        'Q:3.75:3.75': {'v:2.5:2.5': {}, 'v:2.5:5.0': {}, 'v:5.0:5.0': {}, 'v:5.0:2.5': {}},
        'Q:1.25:6.25': {'v:0.0:5.0': {}, 'v:0.0:7.5': {}, 'v:2.5:5.0': {}, 'v:2.5:7.5': {}},
        'Q:1.25:8.75': {
            'v:0.0:7.5': {},
            'v:0.0:10.0': {},
            'v:2.5:7.5': {},
            'v:2.5:10.0': {},
        },
        'Q:3.75:6.25': {'v:2.5:5.0': {}, 'v:2.5:7.5': {}, 'v:5.0:5.0': {}, 'v:5.0:7.5': {}},
        'Q:3.75:8.75': {
            'v:2.5:7.5': {},
            'v:2.5:10.0': {},
            'v:5.0:7.5': {},
            'v:5.0:10.0': {},
        },
        'Q:11.25:1.25': {
            'v:10.0:0.0': {},
            'v:10.0:2.5': {},
            'v:12.5:0.0': {},
            'v:12.5:2.5': {},
        },
        'Q:11.25:3.75': {
            'v:10.0:2.5': {},
            'v:10.0:5.0': {},
            'v:12.5:2.5': {},
            'v:12.5:5.0': {},
        },
        'Q:13.75:1.25': {
            'v:12.5:0.0': {},
            'v:12.5:2.5': {},
            'v:15.0:0.0': {},
            'v:15.0:2.5': {},
        },
        'Q:13.75:3.75': {
            'v:12.5:2.5': {},
            'v:12.5:5.0': {},
            'v:15.0:2.5': {},
            'v:15.0:5.0': {},
        },
        'Q:12.5:-2.5': {
            'v:10.0:0.0': {},
            'v:10.0:-5.0': {},
            'v:15.0:-5.0': {},
            'v:15.0:0.0': {},
        },
        'Q:7.5:-2.5': {
            'v:5.0:0.0': {},
            'v:5.0:-5.0': {},
            'v:10.0:-5.0': {},
            'v:10.0:0.0': {},
        },
        'Q:7.5:7.5': {
            'v:5.0:10.0': {},
            'v:10.0:10.0': {},
            'v:10.0:5.0': {},
            'v:5.0:5.0': {},
        },
        'v:7.5:5.0': {
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:10.0:5.0': {'label': 'E', 'B': 0},
            'v:7.5:2.5': {'label': 'E', 'B': 0},
            'Q:6.25:3.75': {},
            'Q:8.75:3.75': {},
        },
        'v:7.5:0.0': {
            'v:5.0:0.0': {'label': 'E', 'B': 0},
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'v:7.5:2.5': {'label': 'E', 'B': 0},
            'Q:6.25:1.25': {},
            'Q:8.75:1.25': {},
        },
        'v:7.5:2.5': {
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:7.5:5.0': {'label': 'E', 'B': 0},
            'v:7.5:0.0': {'label': 'E', 'B': 0},
            'Q:6.25:3.75': {},
            'Q:6.25:1.25': {},
            'Q:8.75:1.25': {},
            'Q:8.75:3.75': {},
        },
        'Q:6.25:3.75': {'v:5.0:5.0': {}, 'v:5.0:2.5': {}, 'v:7.5:5.0': {}, 'v:7.5:2.5': {}},
        'Q:6.25:1.25': {'v:5.0:0.0': {}, 'v:5.0:2.5': {}, 'v:7.5:0.0': {}, 'v:7.5:2.5': {}},
        'Q:8.75:1.25': {
            'v:10.0:0.0': {},
            'v:10.0:2.5': {},
            'v:7.5:0.0': {},
            'v:7.5:2.5': {},
        },
        'Q:8.75:3.75': {
            'v:10.0:5.0': {},
            'v:10.0:2.5': {},
            'v:7.5:5.0': {},
            'v:7.5:2.5': {},
        },
    }
    assert expected_graph == nx.to_dict_of_dicts(G)
