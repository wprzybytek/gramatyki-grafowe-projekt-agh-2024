import networkx as nx

from plot_graph import plot_graph
from productions.p07.production7 import ProductionP7
from productions.p07.utils import prepare_valid_test_graph_p7, prepare_valid_big_test_graph_p7


def test_basic_graph():
    """ Verifies if structure is valid after applying production 7 to a basic graph"""
    G = prepare_valid_test_graph_p7()

    prod7 = ProductionP7(G)
    prod7.apply()

    expected_graph = {
        'Q': {
            'v:0.0:0.0': {},
            'v:1.0:0.0': {},
            'v:1.0:1.0': {},
            'v:0.0:1.0': {}
        },
        'v:0.0:0.0': {
            'v:0.0:1.0': {'label': 'E', 'B': 1},
            'v:1.0:0.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:1.0:0.0': {
            'v:1.0:1.0': {'label': 'E', 'B': 1},
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:1.0:1.0': {
            'v:1.0:0.0': {'label': 'E', 'B': 1},
            'v:0.0:1.0': {'label': 'E', 'B': 1},
            'Q': {},
        },
        'v:0.0:1.0': {
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:1.0:1.0': {'label': 'E', 'B': 1},
            'Q': {},
        }
    }
    assert expected_graph == nx.to_dict_of_dicts(G)
    assert G.nodes['Q']['R'] == 1


def test_big_graph():
    """ Verifies if structure is valid after applying production 7 to a big graph twelve times"""
    G = prepare_valid_big_test_graph_p7()

    prod7 = ProductionP7(G)
    for _ in range(12):
        prod7.apply()

    expected_graph = {
        'v:0.0:0.0': {
            'v:2.5:0.0': {'label': 'E', 'B': 1},
            'v:0.0:2.5': {'label': 'E', 'B': 1},
            'Q:1.25:1.25': {},
        },
        'v:5.0:0.0': {
            'v:2.5:0.0': {'label': 'E', 'B': 1},
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'v:5.0:-5.0': {'label': 'E', 'B': 1},
            'Q:7.5:2.5': {},
            'Q:7.5:-2.5': {},
            'Q:3.75:1.25': {},
        },
        'v:10.0:0.0': {
            'v:12.5:0.0': {'label': 'E', 'B': 0},
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:5.0:0.0': {'label': 'E', 'B': 0},
            'v:10.0:-5.0': {'label': 'E', 'B': 0},
            'Q:7.5:2.5': {},
            'Q:12.5:-2.5': {},
            'Q:7.5:-2.5': {},
            'Q:11.25:1.25': {},
        },
        'v:10.0:5.0': {
            'v:12.5:5.0': {'label': 'E', 'B': 1},
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:10.0:10.0': {'label': 'E', 'B': 1},
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'Q:7.5:2.5': {},
            'Q:7.5:7.5': {},
            'Q:11.25:3.75': {},
        },
        'v:10.0:10.0': {
            'v:5.0:10.0': {'label': 'E', 'B': 1},
            'v:10.0:5.0': {'label': 'E', 'B': 1},
            'Q:7.5:7.5': {},
        },
        'v:5.0:10.0': {
            'v:2.5:10.0': {'label': 'E', 'B': 1},
            'v:5.0:7.5': {'label': 'E', 'B': 0},
            'v:10.0:10.0': {'label': 'E', 'B': 1},
            'Q:7.5:7.5': {},
            'Q:3.75:8.75': {},
        },
        'v:0.0:10.0': {
            'v:2.5:10.0': {'label': 'E', 'B': 1},
            'v:0.0:7.5': {'label': 'E', 'B': 1},
            'Q:1.25:8.75': {},
        },
        'v:0.0:5.0': {
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'v:0.0:2.5': {'label': 'E', 'B': 1},
            'v:0.0:7.5': {'label': 'E', 'B': 1},
            'Q:1.25:3.75': {},
            'Q:1.25:6.25': {},
        },
        'v:5.0:5.0': {
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'v:5.0:7.5': {'label': 'E', 'B': 0},
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'v:10.0:5.0': {'label': 'E', 'B': 0},
            'Q:7.5:2.5': {},
            'Q:7.5:7.5': {},
            'Q:3.75:3.75': {},
            'Q:3.75:6.25': {},
        },
        'v:5.0:-5.0': {
            'v:5.0:0.0': {'label': 'E', 'B': 1},
            'v:10.0:-5.0': {'label': 'E', 'B': 1},
            'Q:7.5:-2.5': {},
        },
        'v:10.0:-5.0': {
            'v:5.0:-5.0': {'label': 'E', 'B': 1},
            'v:15.0:-5.0': {'label': 'E', 'B': 1},
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'Q:12.5:-2.5': {},
            'Q:7.5:-2.5': {},
        },
        'v:15.0:-5.0': {
            'v:10.0:-5.0': {'label': 'E', 'B': 1},
            'v:15.0:0.0': {'label': 'E', 'B': 1},
            'Q:12.5:-2.5': {},
        },
        'v:15.0:0.0': {
            'v:12.5:0.0': {'label': 'E', 'B': 0},
            'v:15.0:2.5': {'label': 'E', 'B': 1},
            'v:15.0:-5.0': {'label': 'E', 'B': 1},
            'Q:12.5:-2.5': {},
            'Q:13.75:1.25': {},
        },
        'v:15.0:5.0': {
            'v:12.5:5.0': {'label': 'E', 'B': 1},
            'v:15.0:2.5': {'label': 'E', 'B': 1},
            'Q:13.75:3.75': {},
        },
        'v:2.5:10.0': {
            'v:0.0:10.0': {'label': 'E', 'B': 1},
            'v:5.0:10.0': {'label': 'E', 'B': 1},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:1.25:8.75': {},
            'Q:3.75:8.75': {},
        },
        'v:2.5:5.0': {
            'v:0.0:5.0': {'label': 'E', 'B': 0},
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:1.25:3.75': {},
            'Q:3.75:3.75': {},
            'Q:1.25:6.25': {},
            'Q:3.75:6.25': {},
        },
        'v:2.5:0.0': {
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:5.0:0.0': {'label': 'E', 'B': 1},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'Q:1.25:1.25': {},
            'Q:3.75:1.25': {},
        },
        'v:12.5:5.0': {
            'v:10.0:5.0': {'label': 'E', 'B': 1},
            'v:15.0:5.0': {'label': 'E', 'B': 1},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:11.25:3.75': {},
            'Q:13.75:3.75': {},
        },
        'v:12.5:0.0': {
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'v:15.0:0.0': {'label': 'E', 'B': 0},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:11.25:1.25': {},
            'Q:13.75:1.25': {},
        },
        'v:0.0:2.5': {
            'v:0.0:5.0': {'label': 'E', 'B': 1},
            'v:0.0:0.0': {'label': 'E', 'B': 1},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'Q:1.25:1.25': {},
            'Q:1.25:3.75': {},
        },
        'v:0.0:7.5': {
            'v:0.0:10.0': {'label': 'E', 'B': 1},
            'v:0.0:5.0': {'label': 'E', 'B': 1},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:1.25:6.25': {},
            'Q:1.25:8.75': {},
        },
        'v:5.0:2.5': {
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:5.0:0.0': {'label': 'E', 'B': 0},
            'v:2.5:2.5': {'label': 'E', 'B': 0},
            'Q:3.75:1.25': {},
            'Q:3.75:3.75': {},
        },
        'v:5.0:7.5': {
            'v:5.0:5.0': {'label': 'E', 'B': 0},
            'v:5.0:10.0': {'label': 'E', 'B': 0},
            'v:2.5:7.5': {'label': 'E', 'B': 0},
            'Q:3.75:6.25': {},
            'Q:3.75:8.75': {},
        },
        'v:10.0:2.5': {
            'v:10.0:5.0': {'label': 'E', 'B': 0},
            'v:10.0:0.0': {'label': 'E', 'B': 0},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:11.25:1.25': {},
            'Q:11.25:3.75': {},
        },
        'v:15.0:2.5': {
            'v:15.0:5.0': {'label': 'E', 'B': 1},
            'v:15.0:0.0': {'label': 'E', 'B': 1},
            'v:12.5:2.5': {'label': 'E', 'B': 0},
            'Q:13.75:1.25': {},
            'Q:13.75:3.75': {},
        },
        'v:2.5:2.5': {
            'v:0.0:2.5': {'label': 'E', 'B': 0},
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'v:5.0:2.5': {'label': 'E', 'B': 0},
            'v:2.5:0.0': {'label': 'E', 'B': 0},
            'Q:1.25:1.25': {},
            'Q:1.25:3.75': {},
            'Q:3.75:1.25': {},
            'Q:3.75:3.75': {},
        },
        'v:2.5:7.5': {
            'v:0.0:7.5': {'label': 'E', 'B': 0},
            'v:2.5:10.0': {'label': 'E', 'B': 0},
            'v:5.0:7.5': {'label': 'E', 'B': 0},
            'v:2.5:5.0': {'label': 'E', 'B': 0},
            'Q:1.25:6.25': {},
            'Q:1.25:8.75': {},
            'Q:3.75:6.25': {},
            'Q:3.75:8.75': {},
        },
        'v:12.5:2.5': {
            'v:10.0:2.5': {'label': 'E', 'B': 0},
            'v:12.5:5.0': {'label': 'E', 'B': 0},
            'v:15.0:2.5': {'label': 'E', 'B': 0},
            'v:12.5:0.0': {'label': 'E', 'B': 0},
            'Q:11.25:1.25': {},
            'Q:11.25:3.75': {},
            'Q:13.75:1.25': {},
            'Q:13.75:3.75': {},
        },
        'Q:1.25:1.25': {'v:2.5:2.5': {}, 'v:0.0:0.0': {}, 'v:0.0:2.5': {}, 'v:2.5:0.0': {}},
        'Q:1.25:3.75': {'v:0.0:5.0': {}, 'v:2.5:5.0': {}, 'v:2.5:2.5': {}, 'v:0.0:2.5': {}},
        'Q:3.75:1.25': {'v:2.5:2.5': {}, 'v:2.5:0.0': {}, 'v:5.0:0.0': {}, 'v:5.0:2.5': {}},
        'Q:3.75:3.75': {'v:2.5:2.5': {}, 'v:2.5:5.0': {}, 'v:5.0:5.0': {}, 'v:5.0:2.5': {}},
        'Q:1.25:6.25': {'v:0.0:5.0': {}, 'v:0.0:7.5': {}, 'v:2.5:5.0': {}, 'v:2.5:7.5': {}},
        'Q:1.25:8.75': {
            'v:0.0:7.5': {},
            'v:0.0:10.0': {},
            'v:2.5:7.5': {},
            'v:2.5:10.0': {},
        },
        'Q:3.75:6.25': {'v:2.5:5.0': {}, 'v:2.5:7.5': {}, 'v:5.0:5.0': {}, 'v:5.0:7.5': {}},
        'Q:3.75:8.75': {
            'v:2.5:7.5': {},
            'v:2.5:10.0': {},
            'v:5.0:7.5': {},
            'v:5.0:10.0': {},
        },
        'Q:11.25:1.25': {
            'v:10.0:0.0': {},
            'v:10.0:2.5': {},
            'v:12.5:0.0': {},
            'v:12.5:2.5': {},
        },
        'Q:11.25:3.75': {
            'v:10.0:2.5': {},
            'v:10.0:5.0': {},
            'v:12.5:2.5': {},
            'v:12.5:5.0': {},
        },
        'Q:13.75:1.25': {
            'v:12.5:0.0': {},
            'v:12.5:2.5': {},
            'v:15.0:0.0': {},
            'v:15.0:2.5': {},
        },
        'Q:13.75:3.75': {
            'v:12.5:2.5': {},
            'v:12.5:5.0': {},
            'v:15.0:2.5': {},
            'v:15.0:5.0': {},
        },
        'Q:7.5:2.5': {'v:5.0:5.0': {}, 'v:5.0:0.0': {}, 'v:10.0:0.0': {}, 'v:10.0:5.0': {}},
        'Q:12.5:-2.5': {
            'v:10.0:0.0': {},
            'v:10.0:-5.0': {},
            'v:15.0:-5.0': {},
            'v:15.0:0.0': {},
        },
        'Q:7.5:-2.5': {
            'v:5.0:0.0': {},
            'v:5.0:-5.0': {},
            'v:10.0:-5.0': {},
            'v:10.0:0.0': {},
        },
        'Q:7.5:7.5': {
            'v:5.0:10.0': {},
            'v:10.0:10.0': {},
            'v:10.0:5.0': {},
            'v:5.0:5.0': {},
        },
    }
    assert expected_graph == nx.to_dict_of_dicts(G)
    for node in G.nodes:
        if node.startswith('Q'):
            assert G.nodes[node]['R'] == 1
